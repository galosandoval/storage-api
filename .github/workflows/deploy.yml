name: Deploy storage-api to Raspberry Pi (Cloudflare Access SSH)

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      # Build Linux ARM64 binary
      - name: Build linux/arm64
        env:
          CGO_ENABLED: "0"
          GOOS: linux
          GOARCH: arm64
        run: |
          go mod tidy
          go build -ldflags "-s -w" -o storage-api ./cmd/storage-api
          ls -la storage-api
          file storage-api

      # Install cloudflared (used as SSH ProxyCommand for Access)
      - name: Install cloudflared
        run: |
          sudo mkdir -p /usr/share/keyrings
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared jammy main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
          sudo apt-get update
          sudo apt-get install -y cloudflared
          cloudflared --version

      # Write SSH key + SSH config that uses cloudflared access ssh
      - name: Configure SSH for Cloudflare Access
        env:
          PI_SSH_KEY: ${{ secrets.PI_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "$PI_SSH_KEY" > ~/.ssh/pi_deploy_key
          chmod 600 ~/.ssh/pi_deploy_key

          cat > ~/.ssh/config <<'EOF'
          Host storage-pi
            HostName ssh.lau-lo.com
            User pi
            IdentityFile ~/.ssh/pi_deploy_key
            IdentitiesOnly yes
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ProxyCommand cloudflared access ssh --hostname %h
          EOF

          chmod 600 ~/.ssh/config

      # Copy binary to the Pi through Access
      - name: Upload binary to Pi
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          scp storage-api storage-pi:/tmp/storage-api

      # Install + restart service on the Pi
      - name: Install and restart
        env:
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          ssh storage-pi <<'EOF'
            set -euo pipefail
            sudo mv /tmp/storage-api /usr/local/bin/storage-api
            sudo chmod +x /usr/local/bin/storage-api
            sudo systemctl restart storage-api
            sudo systemctl status storage-api --no-pager
          EOF